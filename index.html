<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Heijunka Timeline Horizontal</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      overflow-x: auto;
    }

    .timeline-container {
      position: relative;
      width: 2880px; /* 48h x 60min */
      height: 200px;
      border-top: 2px solid #000;
      background: #f0f0f0;
    }

    .orden {
      position: absolute;
      top: 50px;
      height: 80px;
      background: #4CAF50;
      color: #fff;
      border-radius: 4px;
      padding: 4px;
      box-sizing: border-box;
      cursor: move;
    }

    .orden[data-prioridad="alta"] { background: #e53935; }
    .orden[data-prioridad="media"] { background: #fb8c00; }
    .orden[data-prioridad="baja"] { background: #43a047; }

    .conflicto {
      outline: 3px solid red;
    }

    .hora-marca {
      position: absolute;
      top: 0;
      height: 20px;
      width: 60px;
      border-left: 1px dashed #999;
      font-size: 10px;
      color: #555;
      text-align: left;
      padding-left: 2px;
    }
  </style>
</head>
<body>

<h2>LÃ­nea de Tiempo Horizontal (48h)</h2>
<div class="timeline-container" id="timeline"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script>
  const ordenes = [
    { id: 101, parte: 'PZA-001', cantidad: 100, duracion: 60, fecha: '2025-05-29', horaInicio: '06:30', prioridad: 'alta' },
    { id: 102, parte: 'PZA-002', cantidad: 150, duracion: 90, fecha: '2025-05-29', horaInicio: '08:00', prioridad: 'media' },
    { id: 103, parte: 'PZA-003', cantidad: 200, duracion: 80, fecha: '2025-05-29', horaInicio: '11:00', prioridad: 'baja' },
    { id: 104, parte: 'PZA-004', cantidad: 180, duracion: 120, fecha: '2025-05-30', horaInicio: '07:30', prioridad: 'media' },
    { id: 105, parte: 'PZA-005', cantidad: 90,  duracion: 60, fecha: '2025-05-30', horaInicio: '10:00', prioridad: 'alta' },
    { id: 106, parte: 'PZA-006', cantidad: 160, duracion: 100, fecha: '2025-05-30', horaInicio: '13:00', prioridad: 'baja' }
  ];

  const baseDate = new Date('2025-05-29T00:00:00');

  function minDesdeBase(fechaStr, horaStr) {
    const fecha = new Date(`${fechaStr}T${horaStr}`);
    const diffMs = fecha - baseDate;
    return Math.floor(diffMs / 60000); // minutos
  }

  function generarMarcasHora() {
    const $timeline = $('#timeline');
    for (let i = 0; i <= 48; i++) {
      const left = i * 60;
      const hora = new Date(baseDate.getTime() + i * 3600000);
      const label = hora.toISOString().substring(0, 16).replace('T', ' ');
      $timeline.append(`<div class="hora-marca" style="left: ${left}px;">${label}</div>`);
    }
  }

  function colocarOrdenes() {
    const $timeline = $('#timeline');

    ordenes.forEach(o => {
      const left = minDesdeBase(o.fecha, o.horaInicio);
      const $orden = $(`<div class="orden"
        data-id="${o.id}"
        data-prioridad="${o.prioridad}"
        data-inicio="${left}"
        data-duracion="${o.duracion}"
      >#${o.id}<br>${o.parte}<br>${o.cantidad} pzs</div>`);

      $orden.css({ left: left + 'px', width: o.duracion + 'px' });

      $orden.draggable({
        containment: '#timeline',
        axis: 'x',
        stop: function () {
          validarSolapes();
        }
      });

      $orden.resizable({
        handles: 'e',
        minWidth: 30,
        stop: function (event, ui) {
          const nuevaDuracion = ui.size.width;
          const nuevaCantidad = Math.round(nuevaDuracion);
          $(this).attr('data-duracion', nuevaDuracion).html(`#${o.id}<br>${o.parte}<br>${nuevaCantidad} pzs`);
          validarSolapes();
        }
      });

      $timeline.append($orden);
    });
  }

  function validarSolapes() {
    const $ordenes = $('.orden');
    const posiciones = [];

    $ordenes.removeClass('conflicto');

    $ordenes.each(function () {
      const left = $(this).position().left;
      const width = $(this).outerWidth();
      posiciones.push({ el: this, left, right: left + width });
    });

    for (let i = 0; i < posiciones.length; i++) {
      for (let j = i + 1; j < posiciones.length; j++) {
        if (posiciones[i].right > posiciones[j].left && posiciones[i].left < posiciones[j].right) {
          $(posiciones[i].el).addClass('conflicto');
          $(posiciones[j].el).addClass('conflicto');
        }
      }
    }
  }

  $(function () {
    generarMarcasHora();
    colocarOrdenes();
    validarSolapes();
  });
</script>
</body>
</html>
